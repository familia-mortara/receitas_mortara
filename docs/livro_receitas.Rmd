---
title: "Receitas de família"
author: "Família Mortara"
date: ""
output:
  rmdformats::readthedown:
    self_contained: true
    thumbnails: false
    lightbox: false
    toc_depth: 3
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, echo = FALSE, results = 'asis')
library(knitr) # para compilar arquivo
library(rmdformats) # para formatar o output
library(dplyr) # para manipular os dados
library(glue) # para facilitar a repetição de uma operação
library(stringr)
```

```{r objetos}
source("scripts/01-convert_data.R")
receitas_id <- read.csv("dados/tabela_01.csv")
ingredientes <- read.csv("dados/tabela_02.csv")

receitas_id <- arrange(receitas_id, Categoria, NOME) %>% 
  filter(!is.na(NOME))
categorias <- unique(receitas_id$Categoria)

ingredientes[is.na(ingredientes)] <- ""

ingredientes$string <- paste("-", 
                             ifelse(ingredientes$Quantidade_volume_A != "", 
                                    gsub("\\.0", "", ingredientes$Quantidade_volume_A), 
                                    "\\s"),
                             ingredientes$Medida_volume_A,
                             ifelse(ingredientes$Quantidade_peso_A != "", 
                                    ingredientes$Quantidade_peso_A, 
                                    "\\s"),
                             ingredientes$Medida_peso_A,
                             ingredientes$Ingrediente)  
                             #"\n\n\n\n")

receitas <- left_join(receitas_id, ingredientes, by = c("NOME", "ID"))
```


```{r receitas}
for (categoria in categorias) {
  
  cat(glue::glue("\n\n## {tools::toTitleCase(categoria)}\n\n\n\n"))
  
  df <- filter(receitas, Categoria == categoria)
  nomes <- unique(df$NOME)  
  
  dieta <- function(tipo) {
    tipos <- receitas_id %>% select(starts_with("Dieta")) %>% names()
    figs <- c("../figs/vegetarian.png", 
                "../figs/vegan.png", 
                "../figs/gluten-free.png", 
                "../figs/lactose-free.png")
    names(figs) <- tipos
    path_to_image <- figs[names(figs) == tipo]
    #img <- gsub("path_to_image", path_to_image,
    #            '<img src="path_to_image" height="0.10" width="0.10" />')
    img <- paste0('![](', path_to_image,  '){width=3%}')
    return(img)
  }
  
  
  for (nome in nomes) {
    
    # apenas dados da receita
    df_receita <- filter(receitas, NOME == nome)
    
    # tipo de dieta
    veg_check <- ifelse(all(df_receita$Dieta_Vegetariana == 'Sim'), 
                        dieta("Dieta_Vegetariana"), "")
    lac_check <- ifelse(all(df_receita$Dieta_Sem_lactose == 'Sim'), 
                        dieta("Dieta_Sem_lactose"), "")
    gluten_check <- ifelse(all(df_receita$Dieta_Sem_glúten == 'Sim'), 
                        dieta("Dieta_Sem_glúten"), "")
    vegan_check <- ifelse(all(df_receita$Dieta_Vegana == 'Sim'), 
                        dieta("Dieta_Vegana"), "")
    
    # Receita
    ## nome
    cat(glue("\n\n### {nome}\n\n"))
    ## trabalho e quem
    cat(glue("*Receita de {unique(df_receita$Quem_fazia)}.
             É **{tolower(unique(df_receita$Trabalho))}**!
             Tempo de preparo {unique(df_receita$Tempo_preparo)} horas.*\n\n\n\n"))
    ## ingredientes
    cat("\n\n**Ingredientes:**\n\n")
    ## tipo de dieta
    cat(str_interp('${veg_check} ${vegan_check} ${lac_check} ${gluten_check} \n\n'))
    cat(glue("{df_receita$string}\n\n\n\n"))
    # rendimento
    cat(glue("\n\n**Rendimento:** {unique(df_receita$Rendimento)}\n\n\n\n"))
    ## preparo
    cat(glue("**Preparo:** {unique(df_receita$Preparo)}\n\n\n\n"))
    cat(glue("**Fonte**: {unique(df_receita$Fonte)}\n\n"))
  }
}  
```


